"""
Pydantic 2 models for Vulnerability management.

Provides immutable DTOs and request models for vulnerability tracking
with field validation and type safety.
"""

# flake8: noqa: E501


from datetime import datetime
from typing import Literal, Optional

from penguin_libs.pydantic.base import ImmutableModel, RequestModel
from pydantic import Field, field_validator

VulnerabilitySeverity = Literal["critical", "high", "medium", "low", "unknown"]
"""Vulnerability severity level enumeration."""


class VulnerabilityDTO(ImmutableModel):
    """Immutable Vulnerability data transfer object."""

    id: int
    tenant_id: int
    village_id: str
    cve_id: str
    aliases: Optional[list[str]] = None
    severity: VulnerabilitySeverity
    cvss_score: Optional[float] = None
    cvss_vector: Optional[str] = None
    title: Optional[str] = None
    description: Optional[str] = None
    affected_packages: Optional[list[str]] = None
    fixed_versions: Optional[list[str]] = None
    references: Optional[list[str]] = None
    published_at: Optional[datetime] = None
    modified_at: Optional[datetime] = None
    source: Optional[str] = None
    is_active: bool = True
    created_at: datetime
    updated_at: Optional[datetime] = None


class CreateVulnerabilityRequest(RequestModel):
    """Request to create a new Vulnerability."""

    cve_id: str = Field(..., min_length=1, max_length=50)
    severity: VulnerabilitySeverity
    aliases: Optional[list[str]] = Field(None, max_length=50)
    cvss_score: Optional[float] = Field(None, ge=0.0, le=10.0)
    cvss_vector: Optional[str] = Field(None, max_length=100)
    title: Optional[str] = Field(None, max_length=255)
    description: Optional[str] = Field(None, max_length=5000)
    affected_packages: Optional[list[str]] = Field(None, max_length=500)
    fixed_versions: Optional[list[str]] = Field(None, max_length=500)
    references: Optional[list[str]] = Field(None, max_length=100)
    published_at: Optional[datetime] = None
    source: Optional[str] = Field(None, max_length=100)

    @field_validator("cve_id")
    @classmethod
    def cve_id_format(cls, v: str) -> str:
        """Ensure CVE ID is not just whitespace."""
        if v.strip() == "":
            raise ValueError("CVE ID cannot be empty or whitespace-only")
        return v.strip()

    @field_validator("cvss_score")
    @classmethod
    def cvss_score_valid(cls, v: Optional[float]) -> Optional[float]:
        """Ensure CVSS score is within valid range if provided."""
        if v is not None and (v < 0.0 or v > 10.0):
            raise ValueError("CVSS score must be between 0.0 and 10.0")
        return v


class ComponentVulnerabilityDTO(ImmutableModel):
    """Immutable Component-Vulnerability association data transfer object."""

    id: int
    tenant_id: int
    component_id: int
    vulnerability_id: int
    status: str
    remediation_notes: Optional[str] = None
    remediated_at: Optional[datetime] = None
    remediated_by_id: Optional[int] = None
    created_at: datetime
    updated_at: Optional[datetime] = None


class UpdateComponentVulnerabilityRequest(RequestModel):
    """Request to update a Component-Vulnerability association."""

    status: Optional[
        Literal["open", "investigating", "remediated", "false_positive", "accepted"]
    ] = None
    remediation_notes: Optional[str] = Field(None, max_length=5000)
    remediated_by_id: Optional[int] = None

    @field_validator("status")
    @classmethod
    def status_valid(cls, v: Optional[str]) -> Optional[str]:
        """Ensure status is valid if provided."""
        if v is not None:
            valid_statuses = [
                "open",
                "investigating",
                "remediated",
                "false_positive",
                "accepted",
            ]
            if v not in valid_statuses:
                raise ValueError(
                    f"Invalid status. Must be one of: {', '.join(valid_statuses)}"
                )
        return v


class SyncVulnerabilitiesRequest(RequestModel):
    """Request to sync vulnerabilities."""

    component_ids: Optional[list[int]] = Field(
        None, description="Optional list of component IDs to sync"
    )
    force: bool = Field(False, description="Force re-sync even if recently synced")


class NVDSyncRequest(RequestModel):
    """Request to trigger NVD sync."""

    max_vulns: int = Field(
        500, ge=1, le=5000, description="Maximum vulnerabilities to sync"
    )
    force_refresh: bool = Field(False, description="Force refresh all CVEs")


class AssignVulnerabilityRequest(RequestModel):
    """Request to assign a vulnerability to a service or software."""

    parent_type: Literal["service", "software"] = Field(
        ..., description="Type of parent resource"
    )
    parent_id: int = Field(..., gt=0, description="ID of parent resource")
    notes: Optional[str] = Field(
        None, max_length=5000, description="Optional assignment notes"
    )


__all__ = [
    "VulnerabilitySeverity",
    "VulnerabilityDTO",
    "CreateVulnerabilityRequest",
    "ComponentVulnerabilityDTO",
    "UpdateComponentVulnerabilityRequest",
    "SyncVulnerabilitiesRequest",
    "NVDSyncRequest",
    "AssignVulnerabilityRequest",
]
