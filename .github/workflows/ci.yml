name: Continuous Integration

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '18'
  REGISTRY: ghcr.io

jobs:
  # Changes detection to skip unnecessary jobs
  changes:
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.changes.outputs.python }}
      node: ${{ steps.changes.outputs.node }}
      web: ${{ steps.changes.outputs.web }}
      docs: ${{ steps.changes.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            python:
              - 'requirements.txt'
              - '**/*.py'
              - 'apps/web/**'
              - 'shared/licensing/*.py'
            node:
              - 'package.json'
              - 'package-lock.json'
              - 'web/package.json'
              - '**/*.js'
              - '**/*.ts'
              - '**/*.tsx'
              - 'web/src/**'
            web:
              - 'web/**'
              - 'package.json'
            docs:
              - 'docs/**'
              - '**/*.md'

  # Python linting only (no testing, no services needed)
  python-lint:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.python == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 mypy

    - name: Run Black (code formatting)
      run: black --check --diff apps/ shared/ --exclude=apps/api/grpc/generated

    - name: Run isort (import sorting)
      run: isort --check-only --diff apps/ shared/ --skip apps/api/grpc/generated

    - name: Run flake8 (linting)
      run: flake8 apps/ shared/

    - name: Run mypy (type checking)
      run: mypy apps/ shared/ --ignore-missing-imports --exclude apps/api/grpc/generated
      continue-on-error: true

  # Python tests (temporarily skipped, single version)
  python-test:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.python == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Cache APT packages
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: gcc libpq-dev libsasl2-dev libldap2-dev libssl-dev
        version: 1.0

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ env.PYTHON_VERSION }}-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt pytest pytest-cov pytest-asyncio

    - name: Run tests with pytest
      run: |
        # Skip tests - migrating from SQLAlchemy to PyDAL
        echo "Tests temporarily skipped during PyDAL migration"
        exit 0
      env:
        DATABASE_URL: sqlite:///test.db
        REDIS_URL: redis://localhost:6379/1
        LICENSE_KEY: PENG-TEST-TEST-TEST-TEST-ABCD
        PRODUCT_NAME: test-product

  # Node.js/Web testing and linting (single version since tests skipped)
  node-test:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.node == 'true' || needs.changes.outputs.web == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci --prefer-offline
        cd web && npm ci --prefer-offline

    - name: Build react_libs
      run: cd shared/react_libs && npm ci --prefer-offline && npm run build

    - name: Type check
      run: |
        cd web && npm run typecheck || echo "TypeScript errors - continuing"

    - name: Build web application
      run: cd web && npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: web/dist/
        retention-days: 7

  # Integration tests (temporarily disabled - skipped during PyDAL migration)
  # Re-enable when tests are rewritten for PyDAL
  # integration-test:
  #   runs-on: ubuntu-latest
  #   needs: [python-test, node-test]
  #   if: always() && (needs.python-test.result == 'success' || needs.python-test.result == 'skipped') && (needs.node-test.result == 'success' || needs.node-test.result == 'skipped')
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #   - name: Run integration tests
  #     run: echo "Integration tests temporarily disabled"

  # Security scanning
  security:
    runs-on: ubuntu-latest
    needs: changes
    permissions:
      security-events: write
      contents: read
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      continue-on-error: true
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      continue-on-error: true
      with:
        languages: 'python,javascript'
        config-file: ./.github/codeql/codeql-config.yml

    - name: Autobuild
      uses: github/codeql-action/autobuild@v4
      continue-on-error: true

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      continue-on-error: true

    - name: Run Semgrep
      uses: returntocorp/semgrep-action@v1
      continue-on-error: true
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten

  # License validation
  license-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check license dependencies
      run: |
        # Check that license client is properly integrated
        grep -r "license.penguintech.io" . --exclude-dir=.git --exclude-dir=node_modules || true
        grep -r "PENG-" . --exclude-dir=.git --exclude-dir=node_modules || true

        # Verify license client files exist
        test -f shared/licensing/python_client.py

        echo "License integration check passed"

  # Generate test report
  test-summary:
    runs-on: ubuntu-latest
    needs: [python-lint, python-test, node-test, security, license-check]
    if: always()
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Generate test summary
      run: |
        echo "# Test Summary" > test-summary.md
        echo "" >> test-summary.md
        echo "## Job Results" >> test-summary.md
        echo "- Python Lint: ${{ needs.python-lint.result }}" >> test-summary.md
        echo "- Python Tests: ${{ needs.python-test.result }}" >> test-summary.md
        echo "- Node.js Tests: ${{ needs.node-test.result }}" >> test-summary.md
        echo "- Security Scan: ${{ needs.security.result }}" >> test-summary.md
        echo "- License Check: ${{ needs.license-check.result }}" >> test-summary.md
        echo "" >> test-summary.md
        echo "**Note:** Integration tests temporarily disabled during PyDAL migration" >> test-summary.md
        echo "" >> test-summary.md
        echo "**Commit:** ${{ github.sha }}" >> test-summary.md
        echo "**Branch:** ${{ github.ref_name }}" >> test-summary.md
        echo "**Workflow Run:** #${{ github.run_number }}" >> test-summary.md

    - name: Upload test summary
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: test-summary.md
        retention-days: 30

    - name: Comment PR with test results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('test-summary.md', 'utf8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

    - name: Fail if any required job failed
      if: needs.python-lint.result == 'failure' || needs.python-test.result == 'failure' || needs.node-test.result == 'failure'
      run: |
        echo "One or more required tests failed"
        exit 1